apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ include "jellyfin-db-sync.fullname" . }}"
  namespace: "{{ .Release.Namespace }}"
  labels: {{- include "jellyfin-db-sync.labels" . | nindent 4 }}
data:
  config.yaml: |
    # Generated by Helm chart
    servers:
    {{- range .Values.config.servers }}
      - name: {{ .name | quote }}
        url: {{ .url | quote }}
        api_key: {{ printf "${%s}" (include "jellyfin-db-sync.serverEnvName" .name) | quote }}
        {{- if .passwordless }}
        passwordless: {{ .passwordless }}
        {{- end }}
    {{- end }}

    sync:
      playback_progress: {{ .Values.config.sync.playbackProgress }}
      watched_status: {{ .Values.config.sync.watchedStatus }}
      favorites: {{ .Values.config.sync.favorites }}
      ratings: {{ .Values.config.sync.ratings }}
      playlists: {{ .Values.config.sync.playlists }}
      likes: {{ .Values.config.sync.likes }}
      play_count: {{ .Values.config.sync.playCount }}
      last_played_date: {{ .Values.config.sync.lastPlayedDate }}
      audio_stream: {{ .Values.config.sync.audioStream }}
      subtitle_stream: {{ .Values.config.sync.subtitleStream }}
      progress_debounce_seconds: {{ .Values.config.sync.progressDebounceSeconds }}
      worker_interval_seconds: {{ .Values.config.sync.workerIntervalSeconds }}
      max_retries: {{ .Values.config.sync.maxRetries }}
      dry_run: {{ .Values.config.sync.dryRun }}

    {{- if .Values.config.pathSyncPolicy }}
    path_sync_policy:
    {{- range .Values.config.pathSyncPolicy }}
      - prefix: {{ .prefix | quote }}
        absent_retry_count: {{ .absentRetryCount }}
        {{- if .retryDelaySeconds }}
        retry_delay_seconds: {{ .retryDelaySeconds }}
        {{- end }}
    {{- end }}
    {{- end }}

    database:
      path: {{ .Values.config.database.path | quote }}

    server:
      host: {{ .Values.config.server.host | quote }}
      port: {{ .Values.config.server.port }}

    logging:
      level: {{ .Values.config.logging.level | quote }}
