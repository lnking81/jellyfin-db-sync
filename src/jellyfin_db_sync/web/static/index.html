<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jellyfin DB Sync</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üîÑ Jellyfin DB Sync<span class="version" id="version"></span></h1>
                <span class="uptime" id="uptime">Loading...</span>
            </div>
            <div class="header-controls">
                <span class="status-badge" id="overall-status">Loading</span>
                <button class="refresh-btn" onclick="refreshData()">‚Üª Refresh</button>
            </div>
        </header>

        <div class="grid">
            <!-- Servers Card -->
            <div class="card">
                <div class="card-header">
                    <h2>üì∫ Jellyfin Servers</h2>
                </div>
                <div class="server-list" id="servers-list">
                    <div class="empty-state">Loading...</div>
                </div>
            </div>

            <!-- Queue Status Card -->
            <div class="card">
                <div class="card-header">
                    <h2>üìã Sync Queue</h2>
                </div>
                <div class="stats-grid" id="queue-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="pending-count">-</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="processing-count">-</div>
                        <div class="stat-label">Processing</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value color-yellow" id="waiting-count">-</div>
                        <div class="stat-label">Waiting</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="failed-count">-</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="worker-status">-</div>
                        <div class="stat-label">Worker</div>
                    </div>
                </div>
            </div>

            <!-- Database Status Card -->
            <div class="card">
                <div class="card-header">
                    <h2>üíæ Database</h2>
                </div>
                <div class="stats-grid" id="db-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="db-status">-</div>
                        <div class="stat-label">Status</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="user-mappings">-</div>
                        <div class="stat-label">User Mappings</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="sync-log-count">-</div>
                        <div class="stat-label">Log Entries</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value color-blue" id="item-cache-total">-</div>
                        <div class="stat-label">Media Cache</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="db-size">-</div>
                        <div class="stat-label">DB Size</div>
                    </div>
                </div>
                <div id="item-cache-details" class="cache-details"></div>
            </div>

            <!-- Sync Stats Card -->
            <div class="card">
                <div class="card-header">
                    <h2>üìä Sync Statistics</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value color-green" id="sync-successful">-</div>
                        <div class="stat-label">Successful</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value color-red" id="sync-failed">-</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-synced">-</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="last-sync">-</div>
                        <div class="stat-label">Last Sync</div>
                    </div>
                </div>
            </div>

            <!-- User Mappings Card -->
            <div class="card">
                <div class="card-header">
                    <h2>üë• Users</h2>
                </div>
                <div id="user-mappings-table">
                    <div class="empty-state">Loading...</div>
                </div>
            </div>

            <!-- Waiting for Item Events Table -->
            <div class="card">
                <div class="card-header">
                    <h2>üîç Waiting for Item Import</h2>
                </div>
                <div id="waiting-events">
                    <div class="empty-state">Loading...</div>
                </div>
            </div>

            <!-- Pending Events Table -->
            <div class="card full-width">
                <div class="card-header">
                    <h2>‚è≥ Pending Events</h2>
                </div>
                <div id="pending-events">
                    <div class="empty-state">Loading...</div>
                </div>
            </div>

            <!-- Sync Log -->
            <div class="card full-width">
                <div class="card-header">
                    <h2>üìú Sync Log</h2>
                    <div class="log-controls">
                        <input type="text" id="log-item-filter" placeholder="Search media..." class="log-filter-input" onchange="refreshData()">
                        <select id="log-source-filter" onchange="refreshData()">
                            <option value="">All sources</option>
                        </select>
                        <select id="log-target-filter" onchange="refreshData()">
                            <option value="">All targets</option>
                        </select>
                        <select id="log-type-filter" onchange="refreshData()">
                            <option value="">All types</option>
                            <option value="watched">watched</option>
                            <option value="favorite">favorite</option>
                            <option value="likes">likes</option>
                            <option value="play_count">play_count</option>
                            <option value="last_played">last_played</option>
                            <option value="audio_stream">audio_stream</option>
                            <option value="subtitle_stream">subtitle_stream</option>
                            <option value="progress">progress</option>
                            <option value="rating">rating</option>
                        </select>
                        <select id="log-time-filter" onchange="refreshData()">
                            <option value="30">Last 30 min</option>
                            <option value="60">Last 1 hour</option>
                            <option value="180">Last 3 hours</option>
                            <option value="1440">Last 24 hours</option>
                            <option value="">All time</option>
                        </select>
                    </div>
                </div>
                <div id="sync-log">
                    <div class="empty-state">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <template id="tpl-server-item">
        <div class="server-item">
            <div class="server-info">
                <span class="server-name" data-field="name"></span>
                <span class="server-url" data-field="url"></span>
            </div>
            <div class="server-status">
                <span class="tag" data-field="noauth" style="display:none">NO AUTH</span>
                <span class="tag tag-version" data-field="version"></span>
                <span class="status-dot" data-field="status"></span>
            </div>
        </div>
    </template>

    <template id="tpl-log-entry">
        <div class="log-entry">
            <div class="log-icon" data-field="icon"></div>
            <div class="log-time" data-field="time"></div>
            <div class="log-content">
                <div class="log-header">
                    <span class="log-type" data-field="type"></span>
                    <span class="log-flow" data-field="flow"></span>
                    <span class="log-user" data-field="user"></span>
                    <span class="log-item" data-field="item"></span>
                </div>
                <div class="log-details">
                    <span class="log-value" data-field="value"></span>
                    <span class="log-message" data-field="message"></span>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-pending-row">
        <tr>
            <td data-field="type"></td>
            <td data-field="item"></td>
            <td data-field="user"></td>
            <td data-field="flow"></td>
            <td data-field="retries"></td>
            <td data-field="created"></td>
        </tr>
    </template>

    <template id="tpl-waiting-row">
        <tr>
            <td data-field="type"></td>
            <td data-field="item"></td>
            <td data-field="path"></td>
            <td data-field="target"></td>
            <td data-field="attempt"></td>
            <td data-field="next-retry"></td>
            <td data-field="error"></td>
        </tr>
    </template>

    <template id="tpl-user-row">
        <tr>
            <td class="user-name-cell">
                <span class="user-avatar" data-field="avatar"></span>
                <span class="user-name" data-field="name"></span>
            </td>
        </tr>
    </template>

    <template id="tpl-user-cell">
        <td></td>
    </template>

    <template id="tpl-cache-server">
        <span class="cache-server"><span data-field="name"></span>: <strong data-field="count"></strong></span>
    </template>

    <template id="tpl-events-table">
        <table class="events-table">
            <thead></thead>
            <tbody></tbody>
        </table>
    </template>

    <template id="tpl-users-table">
        <table class="users-table">
            <thead><tr><th>User</th></tr></thead>
            <tbody></tbody>
        </table>
    </template>

    <script src="/static/js/app.js"></script>
</body>
</html>
