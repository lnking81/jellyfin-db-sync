[tox]
envlist = format,lint,type,test,helm
isolated_build = true
skip_missing_interpreters = true

[testenv]
description = Run pytest tests with coverage
usedevelop = true
setenv =
    FORCE_COLOR = 1
    PY_COLORS = 1
    TERM = xterm-256color
deps =
    pytest>=8.0.0
    pytest-asyncio>=0.24.0
    pytest-cov>=6.0.0
commands =
    pytest --color=yes --cov=src/jellyfin_db_sync --cov-report=term-missing --cov-report=xml {posargs:-v}

[testenv:lint]
description = Run linters (ruff check and format)
skip_install = true
setenv =
    FORCE_COLOR = 1
deps =
    ruff>=0.8.0
commands =
    ruff check {posargs:.}
    ruff format --check {posargs:.}

[testenv:type]
description = Run type checking (mypy)
setenv =
    FORCE_COLOR = 1
    MYPY_FORCE_COLOR = 1
deps =
    mypy>=1.13.0
    types-PyYAML>=6.0.0
commands =
    mypy src/

[testenv:format]
description = Format code with ruff
skip_install = true
setenv =
    FORCE_COLOR = 1
deps =
    ruff>=0.8.0
commands =
    ruff format {posargs:.}
    ruff check --fix {posargs:.}

[testenv:helm]
description = Lint and test Helm chart
skip_install = true
allowlist_externals =
    helm
commands =
    helm lint charts/jellyfin-db-sync
    helm template test-release charts/jellyfin-db-sync --debug
    ; Test with custom values (arrays need quotes for shell escaping)
    helm template test-release charts/jellyfin-db-sync \
        --set 'config.servers[0].name=server1' \
        --set 'config.servers[0].url=https://jellyfin.example.com' \
        --set 'config.servers[0].apiKey=test-key' \
        --set persistence.enabled=true \
        --set ingress.enabled=true
